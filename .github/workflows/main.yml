name: Build and Release

on:
  push:
    branches:
      - master
    tags:
      - "v*"
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    - name: Run Tests
      working-directory: ./coincollector
      run: mvn test

  build-jar:
    name: Build JAR
    if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
    needs: test
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Set Maven version from tag (tag builds)
      if: startsWith(github.ref, 'refs/tags/')
      working-directory: ./coincollector
      shell: bash
      run: |
        VERSION="${GITHUB_REF_NAME#v}"
        mvn -q versions:set -DnewVersion="$VERSION" -DgenerateBackupPoms=false

    - name: Build with Maven (skip tests)
      working-directory: ./coincollector
      run: mvn clean package -DskipTests

    - name: Upload JAR
      uses: actions/upload-artifact@v4
      with:
        name: jar-artifact
        path: coincollector/target/coincollector-*.jar


  build-msi:
    name: Build Windows MSI
    if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
    needs: build-jar
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Download JAR
      uses: actions/download-artifact@v4
      with:
        name: jar-artifact
        path: target

    - name: Resolve version + jar file
      shell: powershell
      run: |
        $jar = Get-ChildItem -Path target -Filter 'coincollector-*.jar' | Select-Object -First 1
        if (-not $jar) { Write-Error 'Jar not found'; exit 1 }

        $jarName = $jar.Name
        "JAR_FILE=$jarName" | Out-File -FilePath $env:GITHUB_ENV -Append

        if ($env:GITHUB_REF -like 'refs/tags/*') {
          $tag = $env:GITHUB_REF.Substring(10)
          $ver = $tag.TrimStart('v')
        } else {
          $ver = "0.0.0"
        }

        "APP_VERSION=$ver" | Out-File -FilePath $env:GITHUB_ENV -Append

    - name: Analyze required modules
      shell: powershell
      run: |
        jdeps --ignore-missing-deps --print-module-deps --multi-release 21 "target/$env:JAR_FILE" > modules.txt
        type modules.txt

    - name: Create custom JRE with jlink
      shell: powershell
      run: |
        $modules = Get-Content modules.txt
        jlink `
          --add-modules $modules `
          --strip-debug `
          --no-man-pages `
          --no-header-files `
          --compress=2 `
          --output custom-jre

    - name: Build MSI with jpackage
      shell: powershell
      run: |
        jpackage `
          --input target `
          --name CoinCollector `
          --main-jar $env:JAR_FILE `
          --main-class io.github.lstramke.coincollector.App `
          --type msi `
          --app-version $env:APP_VERSION `
          --vendor "lstramke" `
          --runtime-image custom-jre `
          --win-menu `
          --win-shortcut `
          --win-dir-chooser `
          --win-per-user-install

    - name: Rename MSI (tag builds)
      if: startsWith(github.ref, 'refs/tags/')
      shell: powershell
      run: |
        $msi = Get-ChildItem -Path . -Filter '*.msi' -Recurse | Select-Object -First 1
        if (-not $msi) { Write-Error "MSI not found"; exit 1 }

        $tag = "${{ github.ref_name }}".TrimStart("v")
        $newName = "CoinCollector-$tag.msi"
        Rename-Item -Path $msi.FullName -NewName $newName
        "MSI_FILE=$newName" | Out-File -FilePath $env:GITHUB_ENV -Append

    - name: Upload MSI artifact
      uses: actions/upload-artifact@v4
      with:
        name: CoinCollector-Windows-Installer
        path: "*.msi"

    - name: Publish GitHub Release (tag builds)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        generate_release_notes: true
        files: "${{ env.MSI_FILE }}"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
