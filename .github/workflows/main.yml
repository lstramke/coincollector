name: Build Windows MSI Installer

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-msi:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    - name: Build with Maven
      working-directory: ./coincollector
      run: mvn clean package -DskipTests
    
    - name: Build MSI with jpackage
      run: |
        jpackage `
          --input coincollector/target `
          --name CoinCollector `
          --main-jar coincollector-1.0.0.jar `
          --main-class io.github.lstramke.coincollector.App `
          --type msi `
          --app-version 1.0.0 `
          --vendor "lstramke" `
          --win-menu `
          --win-shortcut `
          --win-dir-chooser
    
    - name: Upload MSI
      uses: actions/upload-artifact@v4
      with:
        name: CoinCollector-Windows-Installer
        path: '*.msi'
